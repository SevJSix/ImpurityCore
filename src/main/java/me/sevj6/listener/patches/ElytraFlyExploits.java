package me.sevj6.listener.patches;

import me.sevj6.Instance;
import me.sevj6.util.ViolationManager;
import me.sevj6.util.fileutil.Setting;
import org.bukkit.World;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityToggleGlideEvent;
import org.bukkit.event.player.PlayerMoveEvent;
import org.bukkit.inventory.ItemStack;

public class ElytraFlyExploits extends ViolationManager implements Listener, Instance {

    private final Setting<Boolean> preventRemountElytraFly = Setting.getBoolean("remount_elytra_fly");
    private final Setting<Boolean> preventFlyOnNetherRoof = Setting.getBoolean("nether_roof_no_fly");

    public ElytraFlyExploits() {
        super(1, 3);
    }

    @EventHandler
    public void onToggle(EntityToggleGlideEvent event) {
        if (event.getEntity() instanceof Player) {
            Player player = (Player) event.getEntity();
            if (preventRemountElytraFly.getValue()) {
                increment(player.getUniqueId());
                if (getVLS(player.getUniqueId()) > 25) {
                    remove(player.getUniqueId());
                    ItemStack chest = player.getInventory().getChestplate();
                    if (chest != null) {
                        player.getInventory().setChestplate(null);
                        if (player.getInventory().firstEmpty() != -1) {
                            player.getInventory().addItem(chest);
                        } else {
                            player.getWorld().dropItemNaturally(player.getLocation(), chest);
                        }
                    }
                }
            }
            if (preventFlyOnNetherRoof.getValue()) {
                if (player.getWorld().getName().equalsIgnoreCase("world_nether")) {
                    if (player.getLocation().getY() < 0 || player.getLocation().getY() > 127) event.setCancelled(true);
                }
            }
        }
    }

    @EventHandler
    public void onMove(PlayerMoveEvent event) {
        if (preventFlyOnNetherRoof.getValue()) {
            if (event.getPlayer().getWorld().getEnvironment() != World.Environment.NETHER) return;
            Player player = event.getPlayer();
            if (!player.isGliding()) return;
            if (player.getLocation().getY() < 0 || player.getLocation().getY() > 127) player.setGliding(false);
        }
    }
}
