package me.sevj6.listeners.packet;

import me.sevj6.Instance;
import me.sevj6.event.NMSEventHandler;
import me.sevj6.event.NMSPacketListener;
import me.sevj6.event.events.PacketEvent;
import me.sevj6.util.fileutil.Configuration;
import net.minecraft.server.v1_12_R1.BlockPosition;
import net.minecraft.server.v1_12_R1.PacketPlayInBlockDig;
import net.minecraft.server.v1_12_R1.PacketPlayOutBlockChange;
import org.bukkit.Location;

import java.lang.reflect.Field;

/**
 * @author SevJ6
 * 8/2/2021
 */

public class NocomExploit implements NMSPacketListener, Instance {

    public static Field blockPos;

    static {
        try {
            NocomExploit.blockPos = PacketPlayOutBlockChange.class.getDeclaredField("a");
            NocomExploit.blockPos.setAccessible(true);
        } catch (Throwable ignored) {
        }
    }

    Configuration exploit = fileConfig.getExploits();

    @NMSEventHandler
    public void onSPacketBlockChange(PacketEvent.Outgoing event) {
        if (event.getPacket() instanceof PacketPlayOutBlockChange) {
            PacketPlayOutBlockChange packet = (PacketPlayOutBlockChange) event.getPacket();
            try {
                BlockPosition pos = (BlockPosition) NocomExploit.blockPos.get(packet);
                Location posLoc = new Location(event.getPlayer().getWorld(), pos.getX(), pos.getY(), pos.getZ());
                if (posLoc.distance(event.getPlayer().getLocation()) > event.getPlayer().getViewDistance() * 16) {
                    event.setCancelled(true);
                }
            } catch (Throwable ignored) {
            }
        }
    }

    @NMSEventHandler
    public void onCPacketBlockDig(PacketEvent.Incoming event) {
        if (event.getPacket() instanceof PacketPlayInBlockDig) {
            PacketPlayInBlockDig packet = (PacketPlayInBlockDig) event.getPacket();
            PacketPlayInBlockDig.EnumPlayerDigType stage = packet.c();
            if (stage.equals(PacketPlayInBlockDig.EnumPlayerDigType.ABORT_DESTROY_BLOCK)
                    || stage.equals(PacketPlayInBlockDig.EnumPlayerDigType.START_DESTROY_BLOCK)
                    || stage.equals(PacketPlayInBlockDig.EnumPlayerDigType.STOP_DESTROY_BLOCK)) {
                BlockPosition blockPos = packet.a();
                Location location = new Location(event.getPlayer().getWorld(), blockPos.getX(), blockPos.getY(), blockPos.getZ());
                if (location.distance(event.getPlayer().getLocation()) > event.getPlayer().getViewDistance() * 16)
                    event.setCancelled(true);
            }
        }
    }
}
